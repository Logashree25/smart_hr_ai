<mvc:View
    controllerName="smart.hr.portal.controller.AttritionMonitor"
    xmlns:mvc="sap.ui.core.mvc"
    xmlns:core="sap.ui.core"
    xmlns:f="sap.f"
    xmlns:card="sap.f.cards"
    xmlns="sap.m">

    <Page id="attritionMonitorPage" 
          title="{i18n>attritionMonitor}" 
          showNavButton="true" 
          navButtonPress="onNavBack">
        
        <!-- Page Header with Summary Stats -->
        <customHeader>
            <Bar id="attritionMonitorHeader">
                <contentLeft>
                    <Title id="attritionMonitorTitle" text="{i18n>attritionMonitor}" level="H1"/>
                </contentLeft>
                <contentMiddle>
                    <HBox id="summaryStatsBox" alignItems="Center" class="sapUiMediumMarginBegin">
                        <VBox id="highRiskCountBox" class="sapUiMediumMarginEnd">
                            <Label id="highRiskCountLabel" text="{i18n>highRiskEmployees}:" class="sapMTextSmall"/>
                            <ObjectNumber id="highRiskCountNumber" 
                                         number="{attritionMonitor>/highRiskCount}" 
                                         state="Error"
                                         emphasized="true"/>
                        </VBox>
                        <VBox id="mediumRiskCountBox" class="sapUiMediumMarginEnd">
                            <Label id="mediumRiskCountLabel" text="{i18n>mediumRiskEmployees}:" class="sapMTextSmall"/>
                            <ObjectNumber id="mediumRiskCountNumber" 
                                         number="{attritionMonitor>/mediumRiskCount}" 
                                         state="Warning"
                                         emphasized="true"/>
                        </VBox>
                        <VBox id="totalAtRiskBox">
                            <Label id="totalAtRiskLabel" text="{i18n>totalAtRisk}:" class="sapMTextSmall"/>
                            <ObjectNumber id="totalAtRiskNumber"
                                         number="{attritionMonitor>/totalAtRiskCount}"
                                         state="Warning"
                                         emphasized="true"/>
                        </VBox>
                    </HBox>
                </contentMiddle>
                <contentRight>
                    <Button id="refreshAttritionBtn"
                            icon="sap-icon://refresh"
                            tooltip="{i18n>refresh}"
                            press="onRefreshAttritionData"
                            type="Transparent"/>
                    <Button id="exportAttritionBtn"
                            icon="sap-icon://excel-attachment"
                            tooltip="{i18n>export}"
                            press="onExportAttritionData"
                            type="Transparent"/>
                </contentRight>
            </Bar>
        </customHeader>
        
        <content>
            <ScrollContainer id="attritionMonitorScrollContainer" height="100%" width="100%" horizontal="false" vertical="true">
                
                <!-- Filter and Sort Controls -->
                <VBox id="filterControlsSection" class="sapUiMediumMargin">
                    <HBox id="filterControlsBar" class="sapUiTinyMarginBottom" wrap="Wrap" alignItems="Center">
                        <Label id="filterByLabel" text="{i18n>filterBy}:" class="sapUiTinyMarginEnd"/>
                        
                        <!-- Urgency Level Filter -->
                        <ComboBox id="urgencyFilterCombo"
                                  selectedKey="{attritionMonitor>/filters/urgencyLevel}"
                                  placeholder="{i18n>allUrgencyLevels}"
                                  selectionChange="onUrgencyFilterChange"
                                  class="sapUiTinyMarginEnd">
                            <core:Item id="allUrgencyItem" key="" text="{i18n>allUrgencyLevels}"/>
                            <core:Item id="highUrgencyItem" key="High" text="{i18n>highUrgency}"/>
                            <core:Item id="mediumUrgencyItem" key="Medium" text="{i18n>mediumUrgency}"/>
                            <core:Item id="lowUrgencyItem" key="Low" text="{i18n>lowUrgency}"/>
                        </ComboBox>
                        
                        <!-- Department Filter -->
                        <ComboBox id="departmentFilterCombo"
                                  selectedKey="{attritionMonitor>/filters/department}"
                                  placeholder="{i18n>allDepartments}"
                                  selectionChange="onDepartmentFilterChange"
                                  items="{attritionMonitor>/departments}"
                                  class="sapUiTinyMarginEnd">
                            <core:Item id="departmentFilterItem" key="{attritionMonitor>}" text="{attritionMonitor>}"/>
                        </ComboBox>
                        
                        <!-- Sort Options -->
                        <ComboBox id="sortOptionsCombo"
                                  selectedKey="{attritionMonitor>/sorting/field}"
                                  selectionChange="onSortChange"
                                  class="sapUiTinyMarginEnd">
                            <core:Item id="sortByRiskItem" key="RiskScore" text="{i18n>sortByRiskScore}"/>
                            <core:Item id="sortByUrgencyItem" key="UrgencyLevel" text="{i18n>sortByUrgency}"/>
                            <core:Item id="sortByNameItem" key="EmployeeName" text="{i18n>sortByName}"/>
                            <core:Item id="sortByDepartmentItem" key="Department" text="{i18n>sortByDepartment}"/>
                        </ComboBox>
                        
                        <Button id="clearFiltersAttritionBtn"
                                icon="sap-icon://clear-filter"
                                text="{i18n>clearFilters}"
                                press="onClearFilters"
                                type="Transparent"/>
                    </HBox>
                </VBox>
                
                <!-- High-Risk Employees List -->
                <VBox id="highRiskEmployeesSection" class="sapUiMediumMargin">
                    <Title id="highRiskEmployeesTitle" text="{i18n>highRiskEmployeesList}" level="H2" class="sapUiMediumMarginBottom"/>
                    
                    <List id="highRiskEmployeesList"
                          items="{path: '/AttritionRisk', 
                                  parameters: {$expand: 'Employee', $filter: 'RiskScore gt 0.6'},
                                  sorter: {path: 'RiskScore', descending: true}}"
                          noDataText="{i18n>noHighRiskEmployees}"
                          mode="SingleSelect"
                          selectionChange="onEmployeeSelect"
                          itemPress="onEmployeePress">
                        
                        <CustomListItem id="highRiskEmployeeItem" 
                                       highlight="{parts: ['UrgencyLevel'], formatter: '.formatUrgencyHighlight'}"
                                       press="onEmployeePress"
                                       type="Active">
                            <content>
                                <HBox id="employeeRiskItemContent" class="sapUiMediumMargin" alignItems="Center">
                                    
                                    <!-- Employee Avatar and Basic Info -->
                                    <VBox id="employeeAvatarInfoBox" class="sapUiMediumMarginEnd" width="25%">
                                        <HBox id="employeeAvatarRow" alignItems="Center" class="sapUiTinyMarginBottom">
                                            <Avatar id="employeeRiskAvatar"
                                                    displaySize="S"
                                                    initials="{parts: ['Employee/FirstName', 'Employee/LastName'], formatter: '.formatInitials'}"
                                                    class="sapUiTinyMarginEnd"/>
                                            <VBox id="employeeNameBox">
                                                <Text id="employeeFullNameText" 
                                                      text="{Employee/FirstName} {Employee/LastName}" 
                                                      class="sapMText"/>
                                                <Text id="employeeRoleText" 
                                                      text="{Employee/Role}" 
                                                      class="sapMTextSmall"/>
                                            </VBox>
                                        </HBox>
                                        <Text id="employeeDepartmentText" 
                                              text="{Employee/Department}" 
                                              class="sapMTextSmall"/>
                                    </VBox>
                                    
                                    <!-- Risk Score and Urgency -->
                                    <VBox id="riskScoreBox" class="sapUiMediumMarginEnd" width="20%">
                                        <Label id="employeeRiskScoreLabel" text="{i18n>riskScore}:" class="sapMTextSmall sapUiTinyMarginBottom"/>
                                        <ObjectNumber id="employeeRiskScore"
                                                     number="{parts: ['RiskScore'], formatter: '.formatRiskPercentage'}"
                                                     unit="%"
                                                     state="{parts: ['UrgencyLevel'], formatter: '.formatRiskState'}"
                                                     emphasized="true"/>
                                        
                                        <!-- Urgency Badge -->
                                        <HBox id="urgencyBadgeBox" class="sapUiTinyMarginTop" alignItems="Center">
                                            <core:Icon id="urgencyIcon"
                                                      src="{parts: ['UrgencyLevel'], formatter: '.formatUrgencyIcon'}"
                                                      color="{parts: ['UrgencyLevel'], formatter: '.formatUrgencyColor'}"
                                                      size="0.75rem"
                                                      class="sapUiTinyMarginEnd"/>
                                            <ObjectStatus id="urgencyStatus"
                                                         text="{UrgencyLevel}"
                                                         state="{parts: ['UrgencyLevel'], formatter: '.formatRiskState'}"/>
                                        </HBox>
                                    </VBox>
                                    
                                    <!-- AI Explanation Excerpt -->
                                    <VBox id="aiExplanationExcerptBox" class="sapUiMediumMarginEnd" width="40%">
                                        <Label id="aiExplanationLabel" text="{i18n>aiExplanationExcerpt}:" class="sapMTextSmall sapUiTinyMarginBottom"/>
                                        <Text id="aiExplanationExcerptText" 
                                              text="{parts: ['ID'], formatter: '.formatExplanationExcerpt'}" 
                                              class="sapMText"
                                              maxLines="3"/>
                                        <Link id="viewFullExplanationLink"
                                              text="{i18n>viewFullExplanation}"
                                              press="onViewFullExplanation"
                                              class="sapUiTinyMarginTop"/>
                                    </VBox>
                                    
                                    <!-- Last Updated and Actions -->
                                    <VBox id="lastUpdatedActionsBox" width="15%">
                                        <Label id="employeeLastUpdatedLabel" text="{i18n>lastUpdated}:" class="sapMTextSmall sapUiTinyMarginBottom"/>
                                        <Text id="employeeLastUpdatedText"
                                              text="{path: 'LastUpdated', type: 'sap.ui.model.odata.type.DateTimeOffset'}"
                                              class="sapMTextSmall sapUiTinyMarginBottom"/>
                                        
                                        <!-- Action Buttons -->
                                        <HBox id="actionButtonsBox" class="sapUiTinyMarginTop">
                                            <Button id="viewEmployeeBtn"
                                                    icon="sap-icon://detail-view"
                                                    tooltip="{i18n>viewEmployee}"
                                                    press="onViewEmployee"
                                                    type="Transparent"
                                                    class="sapUiTinyMarginEnd"/>
                                            <Button id="generateExplanationBtn"
                                                    icon="sap-icon://ai"
                                                    tooltip="{i18n>generateExplanation}"
                                                    press="onGenerateExplanation"
                                                    type="Transparent"
                                                    class="sapUiTinyMarginEnd"/>
                                            <Button id="refreshExplanationBtn"
                                                    icon="sap-icon://refresh"
                                                    tooltip="{i18n>refreshExplanation}"
                                                    press="onRefreshExplanation"
                                                    type="Transparent"/>
                                        </HBox>
                                    </VBox>
                                    
                                </HBox>
                            </content>
                        </CustomListItem>
                        
                    </List>
                </VBox>
                
                <!-- Medium Risk Employees (Collapsible) -->
                <VBox id="mediumRiskEmployeesSection" class="sapUiMediumMargin">
                    <Panel id="mediumRiskPanel" 
                           expandable="true" 
                           expanded="false"
                           headerText="{i18n>mediumRiskEmployees} ({attritionMonitor>/mediumRiskCount})"
                           class="sapUiMediumMarginTop">
                        
                        <List id="mediumRiskEmployeesList"
                              items="{path: '/AttritionRisk', 
                                      parameters: {$expand: 'Employee', $filter: 'RiskScore gt 0.3 and RiskScore le 0.6'},
                                      sorter: {path: 'RiskScore', descending: true}}"
                              noDataText="{i18n>noMediumRiskEmployees}"
                              mode="SingleSelect"
                              selectionChange="onEmployeeSelect"
                              itemPress="onEmployeePress">
                            
                            <!-- Simplified Medium Risk Item -->
                            <StandardListItem id="mediumRiskEmployeeItem"
                                             title="{Employee/FirstName} {Employee/LastName}"
                                             description="{Employee/Role} - {Employee/Department}"
                                             info="{parts: ['RiskScore'], formatter: '.formatRiskPercentage'}%"
                                             infoState="{parts: ['UrgencyLevel'], formatter: '.formatRiskState'}"
                                             press="onEmployeePress"
                                             type="Active"/>
                        </List>
                        
                    </Panel>
                </VBox>
                
            </ScrollContainer>
        </content>
        
        <!-- Footer with Summary Actions -->
        <footer>
            <Toolbar id="attritionMonitorFooter">
                <Text id="attritionSummaryText" text="{attritionMonitor>/summaryText}"/>
                <ToolbarSpacer id="attritionFooterSpacer"/>
                <Button id="generateAllExplanationsBtn"
                        icon="sap-icon://ai"
                        text="{i18n>generateAllExplanations}"
                        press="onGenerateAllExplanations"
                        type="Default"/>
                <Button id="createRetentionPlanBtn"
                        icon="sap-icon://create"
                        text="{i18n>createRetentionPlan}"
                        press="onCreateRetentionPlan"
                        type="Emphasized"/>
            </Toolbar>
        </footer>
        
    </Page>
</mvc:View>
